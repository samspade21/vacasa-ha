name: "Dependency Health Checks"

on:
  schedule:
    - cron: "0 0 * * 1" # Weekly on Monday
  workflow_dispatch:
  push:
    paths:
      - "requirements.txt"
      - "custom_components/vacasa/manifest.json"

jobs:
  dependency-audits:
    runs-on: ubuntu-latest
    name: Dependency Audits
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tooling and project dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools pip-audit packaging
          pip install -r requirements.txt

      - name: Check for outdated packages
        run: |
          pip list --outdated --format=json > outdated.json
          if [ -s outdated.json ] && [ "$(cat outdated.json)" != "[]" ]; then
            echo "::warning::Outdated packages found"
            cat outdated.json
          fi

      - name: Comprehensive security audit
        run: |
          pip-audit --format=json --output=audit.json || true
          if [ -s audit.json ]; then
            echo "::warning::Security vulnerabilities found in dependencies"
            cat audit.json
          fi

      - name: Validate manifest dependencies
        run: |
          python -c "
          import json
          import pkg_resources
          import sys

          # Load manifest
          with open('custom_components/vacasa/manifest.json', 'r') as f:
              manifest = json.load(f)

          # Check if all dependencies are valid
          requirements = manifest.get('requirements', [])
          invalid_deps = []

          for req in requirements:
              try:
                  pkg_resources.Requirement.parse(req)
              except Exception as e:
                  invalid_deps.append(f'{req}: {e}')

          if invalid_deps:
              print('Invalid dependencies found:')
              for dep in invalid_deps:
                  print(f'  - {dep}')
              sys.exit(1)

          print(f'All {len(requirements)} dependencies are valid')
          "

      - name: Check minimum Home Assistant version
        run: |
          python -c "
          import json
          from packaging import version

          # Load manifest
          with open('custom_components/vacasa/manifest.json', 'r') as f:
              manifest = json.load(f)

          # Get minimum HA version
          min_ha_version = manifest.get('homeassistant', '0.0.0')

          # Check if version is reasonable (not too old)
          min_version = version.parse(min_ha_version)
          current_year = 2025

          if min_version.major < current_year - 2:
              print(f'::warning::Minimum Home Assistant version {min_ha_version} might be too old')

          print(f'Minimum Home Assistant version: {min_ha_version}')
          "

      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            outdated.json
            audit.json

  notify-security-issues:
    runs-on: ubuntu-latest
    name: Notify Security Issues
    if: failure()
    needs: [dependency-audits]
    steps:
      - name: Create security issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Security Alert: Dependency vulnerabilities found`;
            const body = `
            ## Security Alert

            Automated dependency security scan found potential vulnerabilities.

            **Action Required:**
            1. Review the security audit report in the workflow artifacts
            2. Update affected packages to secure versions
            3. Test the integration after updates

            **Workflow:** ${{ github.workflow }}
            **Run:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}

            This issue was created automatically by the dependency management workflow.
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'dependencies', 'automated']
            });
